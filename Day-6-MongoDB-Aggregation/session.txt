ржЯрзНрж░рж╛ржиржЬрзЗржХрж╢ржи ржПржмржВ рж░рзЛрж▓ржмрзНржпрж╛ржХ рж╣рж▓рзЛ ржЕрждрзНржпржирзНржд ржЧрзБрж░рзБрждрзНржмржкрзВрж░рзНржг ржбрж╛ржЯрж╛ржмрзЗрж╕ ржЕржкрж╛рж░рзЗрж╢ржи ржпрж╛ ржПржХржЗ рж╕ржоржпрж╝рзЗ ржПржХржЬржи ржЗржЙржЬрж╛рж░рзЗрж░ ржПржХрж╛ржзрж┐ржХ ржХрж╛ржЬ рж╕ржорзНржкржирзНржи ржХрж░рзЗред рждрзЛ ржЖржорж░рж╛ рж╕рж┐ржорзНржкрж▓рзЗрж░ ржнрж┐рждрж░ ржЧрж░рзНржЬрж┐ржпрж╝рж╛ржЫ ржПржХржЯрж╛ ржПржХрзНрж╕рж╛ржорзНржкрж▓ ржЪрж┐ржирзНрждрж╛ ржХрж░рждрзЗ ржкрж╛рж░рж┐ред ржоржирзЗ ржХрж░рзЗржи ржЖржкржирж┐ ржмрж┐ржХрзНржпрж╛рж╢ ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢ржи ржмрзНржпржмрж╣рж╛рж░ ржХрж░ржЫрзЗржи, рждрзЛ ржЖржкржирж╛рж░ ржкрзНрж░рзЯрзЛржЬржи рж╣рж▓ рззрзжрзж ржЯрж╛ржХрж╛ ржХрж╛ржЙржХрзЗ рж╕рзЗржирзНржб ржХрж░ржмрзЗржиред ржЯрзНрж░рж╛ржиржЬрзЗржХрж╢ржиржЯрж┐ ржпржжрж┐ рж╕ржорзНржкрзВрж░рзНржг рж╣ржпрж╝ ржПржмржВ ржХрзЛржи рж╕ржорж╕рзНржпрж╛ ржирж╛ рж╣ржпрж╝ рждрж╛рж╣рж▓рзЗ рззрзжрзж ржЯрж╛ржХрж╛ ржпрж╛ржХрзЗ ржкрж╛ржарж╛ржмрзЗржи рж╕рзЗ ржкрзЗрзЯрзЗ ржпрж╛ржмрзЗред ржЖржкржирж╛рж░ ржПржХрж╛ржЙржирзНржЯ ржерзЗржХрзЗ рззрзжрзж ржЯрж╛ржХрж╛ ржХрзЗржЯрзЗ рждрж╛рж░ ржПржХрж╛ржЙржирзНржЯ ржпрзЛржЧ рж╣ржмрзЗред ржПрждржЯрзБржХрзБ ржмрзБржЭрзЗ ржлрзЗрж▓рзЗржи рждрж╛ржЗрж▓рзЗ ржПржХржЯрж╛ рж╣рж╛ржд рждрж╛рж▓рж┐ ржжрзЗржи ЁЯСП ржоржирзЗ ржХрж░рзЗржи ржПржЦрж╛ржирзЗ ржжрзБржЗржЯрж╛ ржЕржкрж╛рж░рзЗрж╢ржи, ржПржХржЯрж╛ рж╣рж▓ рззрзжрзж ржЯрж╛ржХрж╛ ржЖржкржирж╛рж░ ржПржХрж╛ржЙржирзНржЯ ржерзЗржХрзЗ ржмрж┐рзЯрзЛржЧ, ржЖрж░рзЗржЯрж╛ рж╣рж▓ рждрж╛рж░ ржПржХрж╛ржЙржирзНржЯрзЗ рззрзжрзж ржЯрж╛ржХрж╛ ржпрзЛржЧ ржХрж░рж╛ред рждрзЛ ржзрж░рзЗржи ржПржХржЯрж╛ ржЕржкрж╛рж░рзЗрж╢ржи рж╕ржорзНржкржирзНржи рж╣рж▓ ржЖрж░рзЗржХржЯрж╛ рж╣рж▓ ржирж╛!! ржорж╛ржирзЗ ржЖржкржирж╛рж░ ржПржХрж╛ржЙржирзНржЯ ржерзЗржХрзЗ рззрзжрзж ржЯрж╛ржХрж╛ ржХрзЗржЯрзЗ ржирж┐рж▓ , рждрж╛рж░ ржПржХрж╛ржЙржирзНржЯрзЗ рззрзжрзж ржЯрж╛ржХрж╛ ржпрзЛржЧ рж╣рж▓ ржирж╛!!!
рждрж╛ржЗрж▓рзЗ ржХрж┐ ржорж╛ржирж╛ ржпрж╛рзЯ ржмрзНржпрж╛ржкрж╛рж░ ржЯрж╛ ?
рждрзЛ ржПржЗ рж╕ржорж╕рзНржпрж╛ ржЯрж╛ рж╕ржорж╛ржзрж╛ржи ржХрж░рж╛рж░ ржЬржирзНржп ржЖржорж░рж╛ ржЯрзНрж░рж╛ржиржЬрзЗржХрж╢ржи ржПржмржВ рж░рзЛрж▓ржмрзНржпрж╛ржХ ржЗржЙржЬ ржХрж░ржмрзЛред ржХрзЛржиржУ ржбрж╛ржЯрж╛рж░ ржЖржкржбрзЗржЯ ржмрзНржпрж░рзНрже рж╣ржпрж╝рзЗ ржпрж╛ржпрж╝, ржмрж╛ ржХрзЛржиржУ ржЕржкрзНрж░рждрзНржпрж╛рж╢рж┐ржд ржбрзЗржЯрж╛ ржкрж░рж┐ржмрж░рзНрждржи рж╣ржпрж╝рзЗ ржпрж╛ржпрж╝ред ржПржЗ ржзрж░ржгрзЗрж░ рж╕ржорж╕рзНржпрж╛ржЧрзБрж▓рж┐рж░ рж╕ржорж╛ржзрж╛ржирзЗрж░ ржЬржирзНржп, ржЯрзНрж░рж╛ржиржЬрзЗржХрж╢ржи ржПржмржВ рж░рзЛрж▓ржмрзНржпрж╛ржХ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣ржпрж╝ред ржЕрж░рзНржерж╛рзО, ржЯрзНрж░рж╛ржиржЬрзЗржХрж╢ржирзЗрж░ рж╕ржоржпрж╝ ржЖржкржирж┐ ржбрж╛ржЯрж╛ржмрзЗржЗржЬрзЗ ржХрзЛржиржУ ржкрж░рж┐ржмрж░рзНрждржи ржирж╛ ржХрж░рзЗ рждрж╛ ржкрж░ржмрж░рзНрждрзАрждрзЗ рж░рзЛрж▓ржмрзНржпрж╛ржХ ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗржиредржорж╛ржирзЗ ржЖржкржирж╛рж░ ржерзЗржХрзЗ рззрзжрзж ржЯрж╛ржХрж╛ ржмрж┐рзЯрзЛржЧ ржХрж░рзЗ рждрж╛рж░ ржПржХрж╛ржЙржирзНржЯрзЗ рззрзжрзж ржЯрж╛ржХрж╛ ржпрзЛржЧ ржХрж░рж╛ ржкрж░рзНржпржирзНржд success рж░рзЗрж╕ржкржирзНрж╕ ржжрж┐ржмрзЗ ржирж╛, ржпржжрж┐ session ржЯрж┐ ржХржоржкрзНрж▓рж┐ржЯ рж╣рзЯ рждржЦржи success рж░рзЗрж╕ржкржирзНрж╕ ржжрж┐ржмрзЗред ржЖрж░ ржпржжрж┐ ржЕржкрж╛рж░рзЗрж╢ржи ржХрж░рждрзЗ ржХрзЛржи error рж╣рзЯ ржорж╛ржирзЗ ржЙржкрж░рзЗрж░ рж╕рж┐ржорзНржкрж▓рзЗрж░ ржнрж┐рждрж░ ржЧрж░рзНржЬрж┐ржпрж╝рж╛ржЫ ржПржХрзНрж╕рж╛ржорзНржкрж▓рзЗрж░ ржоржд рж╣рзЯ рждрж╛ржЗрж▓рзЗ ржЖржкржирж╛рж░ ржПржХрж╛ржЙржирзНржЯ ржерзЗржХрзЗ рззрзжрзж ржЯрж╛ржХрж╛ ржЖрж░ ржХрзЗржЯрзЗ ржирж┐ржмрзЗ ржирж╛ ред ржмрж░ржВ рж░рзЛрж▓ржмрзНржпрж╛ржХ ржХрж░рзЗ ржЖржЧрзЗрж░ ржЕржмрж╕рзНржерж╛ржирзЗ ржирж┐рзЯрзЗ ржпрж╛ржмрзЗредржЯрзНрж░рж╛ржиржЬрзЗржХрж╢ржи ржПржмржВ рж░рзЛрж▓ржмрзНржпрж╛ржХ Atomic Consistent Isolated Durable. ржПржЯржорж┐ржХ (Atomic), рж╕ржВржпрзБржХрзНржд (Consistent), ржЖржЗрж╕рзЛрж▓рзЗржЯрзЗржб (Isolated) ржПржмржВ ржЯрзНрж░рж╛ржиржЬрзЗржХрж╢ржирж╛рж▓ (Durable) ржПржЗ ржЪрж╛рж░ржЯрж┐ рж╕рзБрж░ржХрзНрж╖рж╛рж░ ржзрж╛рж░ржгрж╛рж░ ржЙржкрж░ ржирж┐рж░рзНржнрж░ ржХрж░рзЗред
рждрзЛ ржПржЗржмрж╛рж░ ржЖржорж░рж╛ ржХрзЛржбрзЗрж░ ржПржХрзНрж╕рж╛ржорзНржкрж▓ ржжрж┐рзЯрзЗ ржЗржоржкрзНрж▓рж┐ржорзЗржирзНржЯрзЗрж╢ржи ржжрзЗржЦржмрзЛред
// ржХрж╛рж╕рзНржЯржорж╛рж░рзЗрж░ рждржерзНржп
  const customer = {
    name: "jhon doe",
    email: "john.doe@example.com",
    address: "anddorkilla banddorban 123",
  };

  // product ржПрж░ рждржерзНржп
  const products = [
    { name: "iPhone 15", price: 999, quantity: 2 },
    { name: "Walton premio zx9", price: 399, quantity: 5 },
  ];
let newCreatedOrder = null;
const session = await mongoose.startSession();

try {
  session.startTransaction();

  const orderId = await generateOrderId();
 
  let customerId;
  const existingCustomer = await Customer.findOne({ email: customer.email });
  if (existingCustomer) {
    customerId = existingCustomer._id;
  } else {
    const newCustomer = await Customer.create([customer], { session });
    customerId = newCustomer[0]._id;
  }

  const newOrder = {
    orderId: orderId,
    customerId: customerId,
    products: [],
    totalAmount: 0,
  };

  for (const product of products) {
    const newProduct = await Product.create([product], { session });
    newOrder.products.push(newProduct[0]._id);
    newOrder.totalAmount += product.price * product.quantity;
  }

 
  const createdOrder = await Order.create([newOrder], { session });
  newCreatedOrder=createdOrder[0]);

  await session.commitTransaction();
  await session.endSession();

} catch (error) {
  await session.abortTransaction();
  await session.endSession();
  throw error;
}
ржПржЗ ржЙржжрж╛рж╣рж░ржг ржЖржорж░рж╛ ржЙржкрж░рзЗрж░ ржХрзЛржбржЯрж┐ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржирждрзБржи ржЕрж░рзНржбрж╛рж░ рждрзИрж░рж┐ ржХрж░ржмрзЛред ржЖржорж░рж╛ ржПржХржЯрж┐ ржЕржирж▓рж╛ржЗржи рж╢ржкрж┐ржВ ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢ржирзЗрж░ ржЙржжрж╛рж╣рж░ржг рж╣рж┐рж╕рж╛ржмрзЗ ржмрж┐ржмрзЗржЪржирж╛ ржХрж░ржмрзЛ ржпрзЗржЦрж╛ржирзЗ user ржПржмржВ product рждржерзНржп ржжрж┐рзЯрзЗ ржПржХржЯрж┐ ржирждрзБржи ржЕрж░рзНржбрж╛рж░ рждрзИрж░рж┐ ржХрж░ржмрзЛ ржЯрзНрж░рж╛ржиржЬрзЗржХрж╢ржи ржПржмржВ рж░рзЛрж▓ржмрзНржпрж╛ржХ use ржХрж░рзЗред
let newCreatedOrder = null;ржЖржорж░рж╛ newCreatedOrder ржПржХржЯрж╛ ржнрзЗрж░рж┐рзЯрзЗржмрж▓ ржирж┐ржЫрж┐ ржпрж╛рж░ ржорж╛ржи рж╣ржЪрзНржЫрзЗ null ;
const session = await mongoose.startSession();ржПржЗ ржлрж╛ржВрж╢ржиржЯрж┐ ржХрж▓ ржХрж░рж▓рзЗ ржПржХржЯрж┐ ржоржЩрзНржЧрзЛржбржмрж┐ рж╕рзЗрж╢ржи ржХржиржЯрзЗржХрзНрж╕ржЯ рждрзИрж░рж┐ ржХрж░рзЗред mongoose.startSession() ржХрж▓ ржХрж░рзЗ рж╕рзЗрж╢ржи рж╢рзБрж░рзБ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ ржПржмржВ session ржнрзНржпрж╛рж░рж┐рзЯрзЗржмрж▓рзЗ рж╕рзЗрж╢ржи ржЕржмржЬрзЗржХрзНржЯ рж╕рзНржЯрзЛрж░ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗред
рждрж╛рж░ ржкрж░рзЗрж░ ржХрж╛ржЬ ржЧрзБрж▓рж┐ ржХрж░рждрзЗ рж╣рзЯ try-catch ржмрзНрж▓ржХрзЗрж░ ржПрж░ ржнрж┐рждрж░ ред try-catch ржмрзНрж▓ржХржЯрж┐ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣рзЯ рждржЦржи ржпржжрж┐ ржХрзЛржбрзЗ ржХрзЛржи error рж╣рждрзЗ ржкрж╛рж░рзЗ ржПржмржВ рж╕рзЗржЗ error рж╣рзНржпрж╛ржирзНржбрж▓ ржХрж░рж╛ ржкрзНрж░рзЯрзЛржЬржи рж╣рждрзЗ ржкрж╛рж░рзЗред ржмрж▓рждрзЗ ржЧрзЗрж▓рзЗ, try-catchржмрзНрж▓ржХржЯрж┐ error рж╣рзНржпрж╛ржирзНржбрж▓ ржХрж░рж╛рж░ ржЬржирзНржп ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣рзЯред
session.startTransaction() рж▓рж╛ржЗржиржЯрж┐ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржЯрзНрж░рж╛ржиржЬрзЗржХрж╢ржи рж╢рзБрж░рзБ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗред ржЯрзНрж░рж╛ржиржЬрзЗржХрж╢ржи ржХржирзНржЯрзЗржХрзНрж╕ржЯрзЗ ржЕржирзЗржХржЧрзБрж▓рж┐ ржЕржкрж╛рж░рзЗрж╢ржирзЗрж░ ржЧрзНрж░рзБржк ржерж╛ржХрждрзЗ ржкрж╛рж░рзЗ, ржПржмржВ рж╕ржорж╕рзНржд ржЕржкрж╛рж░рзЗрж╢ржи рж╕ржорзНржкрзВрж░рзНржг рж╣рж▓рзЗ ржХржорж┐ржЯ ржХрж░рж╛ рж╣рзЯред ржПржХржЯрж┐ ржмрж╛ ржПржХрж╛ржзрж┐ржХ ржЕржкрж╛рж░рзЗрж╢ржи ржмрзНржпрж░рзНрже рж╣рж▓рзЗ, рж╕ржорж╕рзНржд ржЕржкрж╛рж░рзЗрж╢ржи рж░рзЛрж▓ржмрзНржпрж╛ржХ ржХрж░рж╛ рж╣рзЯ ржПржмржВ ржкрзВрж░рзНржмрзЗрж░ ржЕржмрж╕рзНржерж╛рзЯ ржлрж┐рж░рж┐рзЯрзЗ ржЖржирж╛ рж╣рзЯред
const orderId = await generateOrderId();ржлрж╛ржВрж╢ржиржЯрж┐ ржХрж▓ ржХрж░рзЗ orderId ржПрж░ ржЖржЗржбрж┐ рждрзИрж░рж┐ ржХрж░рзЗ рж╣рзЯрзЗржЫрзЗред
let customerId;
const existingCustomer = await Customer.findOne({ email: customer.email });
if (existingCustomer) {
customerId = existingCustomer._id;
} else {
const newCustomer = await Customer.create([customer], { session });
customerId = newCustomer[0]._id;
}
ржПржЗ ржХрзЛржбржЯрж┐ ржХрж╛рж╕рзНржЯржорж╛рж░рзЗрж░ ржЗржорзЗрж▓ ржЕрзНржпрж╛ржбрзНрж░рзЗрж╕рзЗрж░ ржЙржкрж░ ржнрж┐рждрзНрждрж┐ ржХрж░рзЗ ржбрж╛ржЯрж╛ржмрзЗрж╕рзЗ ржХрж╛рж╕рзНржЯржорж╛рж░ exist ржЖржЫрзЗ ржХрж┐ ржирж╛ рждрж╛ ржЪрзЗржХ ржХрж░рзЗред ржпржжрж┐ ржХрж╛рж╕рзНржЯржорж╛рж░ ржерзЗржХрзЗ ржерж╛ржХрзЗ , рждржЦржи ржЖржорж░рж╛ рж╕рзЗржЗ ржХрж╛рж╕рзНржЯржорж╛рж░рзЗрж░ ржЖржЗржбрж┐ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж┐ред ржЕржирзНржпржерж╛ржпрж╝, ржЖржорж░рж╛ ржирждрзБржи ржХрж╛рж╕рзНржЯржорж╛рж░ create ржХрж░рзЗ ржЖржЗржбрж┐ customerId ржПржЗ ржнрзЗрж░рж┐рзЯрзЗржмрж▓рзЗ рж╕рзЗржЯ ржХрж░рж┐ред
const newCustomer = await Customer.create([customer], { session });
ржПржЗ рж▓рж╛ржЗржирзЗ, Customer.create ржПржХржЯрж┐ ржорзЗржержб ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ ржпрж╛ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржирждрзБржи ржХрж╛рж╕рзНржЯржорж╛рж░ ржбржХрзБржорзЗржирзНржЯ рждрзИрж░рж┐ ржХрж░рждрзЗ ржмрзНржпржмрж╣рзГржд рж╣ржпрж╝ред ржПржЗ ржорзЗржержбржЯрж┐ ржжрзБржЯрж┐ ржкрзНржпрж╛рж░рж╛ржорж┐ржЯрж╛рж░ ржирзЗржпрж╝: ржкрзНрж░ржержо ржкрзНржпрж╛рж░рж╛ржорж┐ржЯрж╛рж░ржЯрж┐ рж╣рж▓рзЛ ржПржХржЯрж┐ ржЕрзНржпрж╛рж░рзЗ, ржпрж╛ ржирждрзБржи ржХрж╛рж╕рзНржЯржорж╛рж░рзЗрж░ ржбрзЗржЯрж╛ ржбрж╛ржЯрж╛ржмрзЗрж╕рзЗ save ржХрж░рж╛ржирзЛрж░ ржЬржирзНржп ржмрзНржпржмрж╣рзГржд рж╣ржпрж╝ред ржЕрзНржпрж╛рж░рзЗ рж╣рж┐рж╕рж╛ржмрзЗ ржкрж╛рж╕ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ ржХрж╛рж░ржг create ржорзЗржержбржЯрж┐ ржПржХржЯрж┐ ржПржХрж╛ржзрж┐ржХ ржбржХрзБржорзЗржирзНржЯ ржПржХрждрзНрж░рзЗ ржЧрзНрж░рж╣ржг ржХрж░рждрзЗ ржкрж╛рж░рзЗред ржЖржорж░рж╛ ржпржжрж┐ ржПржХрж╛ржзрж┐ржХ ржирждрзБржи ржХрж╛рж╕рзНржЯржорж╛рж░ ржбржХрзБржорзЗржирзНржЯ ржПржХрждрзНрж░рж┐ржд ржХрж░рзЗ ржПржХржЯрж┐ ржХрж▓рзЗ save ржХрж░рждрзЗ ржЪрж╛ржЗ, рждржмрзЗ ржПржХржЯрж┐ ржЕрзНржпрж╛рж░рзЗ ржжрж┐ржпрж╝рзЗ ржЖржорж░рж╛ ржПржХржЯрж┐ ржХрж▓ ржХрж░рзЗ ржЕржирзЗржХржЧрзБрж▓рж┐ ржХрж╛рж╕рзНржЯржорж╛рж░ ржбржХрзБржорзЗржирзНржЯ save ржХрж░рждрзЗ ржкрж╛рж░рж┐ред ржПржЗ ржХрзНрж╖рзЗрждрзНрж░рзЗ, ржХрзЗржмрж▓ржорж╛рждрзНрж░ ржПржХржЯрж┐ ржирждрзБржи ржХрж╛рж╕рзНржЯржорж╛рж░ save ржХрж░ржЫрж┐, рждрж╛ржЗ ржПржХржЯрж┐ ржПржХржЯрж┐ ржЙржкрж╛ржжрж╛ржи ржзрж╛рж░ржг ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ - customer ржЕржмржЬрзЗржХрзНржЯред
ржжрзНржмрж┐рждрзАржпрж╝ ржкрзНржпрж╛рж░рж╛ржорж┐ржЯрж╛рж░ржЯрж┐ ржПржХржЯрж┐ ржЕржкрж╢ржи ржЕржмржЬрзЗржХрзНржЯ ржЖржорж░рж╛ ржирждрзБржи ржХрж╛рж╕рзНржЯржорж╛рж░ create ржХрж░рж╛рж░ рж╕ржорзЯ ржкрзНржпрж╛рж░рж╛ржорж┐ржЯрж╛рж░рзЗ session ржЕржмржЬрзЗржХрзНржЯ ржЯрж┐ ржкрж╛ржарж┐рзЯрзЗржЫрж┐ ржпрж╛рж░ ржорж╛ржзрзНржпржорзЗ ржЯрзНрж░рж╛ржиржЬрзЗржХрж╢ржирзЗрж░ рж╕рж╛ржерзЗ рж╕ржВржпрзБржХрзНржд рж╣ржмрзЗред ржЯрзНрж░рж╛ржиржЬрзЗржХрж╢ржиржЯрж┐ржХрзЗ ржХржорж┐ржЯ ржмрж╛ рж░рзЛрж▓ржмрзНржпрж╛ржХ ржХрж░рждрзЗ ржкрж╛рж░ржмрзЛред ржПржЯрж┐ ржЖржорж╛ржжрзЗрж░ржХрзЗ ржбрж╛ржЯрж╛ржмрзЗрж╕рзЗ рж╕рж┐ржХрж┐ржЙрж░ ржУ ржХржирж╕рж┐рж╕рзНржЯрзЗржирзНржЯ ржжрж┐рзЯрзЗ ржерж╛ржХрзЗ рждрж╛ржЗ session ржЕржмржЬрзЗржХрзНржЯ ржЯрж┐ ржкрж╛ржарж╛ржирзЛ рж╣рзЯржЫрзЗ ред
const newOrder = {
    orderId: orderId,
    customerId: customerId,
    products: [],
    totalAmount: 0,
  };
ржПржЗ ржХрзЛржбрзЗ newOrder ржирж╛ржоржХ ржПржХржЯрж┐ ржЕржмржЬрзЗржХрзНржЯ рждрзИрж░рж┐ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗред ржПржЗ ржЕржмржЬрзЗржХрзНржЯрзЗрж░ ржорж╛ржзрзНржпржорзЗ ржирждрзБржи ржПржХржЯрж┐ ржЕрж░рзНржбрж╛рж░ рждрзИрж░рж┐ ржХрж░рж╛ рж╣ржмрзЗред ржПржЗ ржЕрж░рзНржбрж╛рж░рзЗ ржЖржЫрзЗ ржирж┐ржорзНржирж▓рж┐ржЦрж┐ржд ржкрзНрж░ржкрж╛рж░рзНржЯрж┐ржЧрзБрж▓рж┐:
orderId: ржПржЯрж┐ ржкрзВрж░рзНржмрзЗ рждрзИрж░рж┐ ржХрж░рж╛ orderId ржнрзЗрж░рж┐ржпрж╝рзЗржмрж▓рзЗрж░ ржорж╛ржиржЯрж┐ ржзрж╛рж░ржг ржХрж░ржмрзЗред
customerId: ржПржЯрж┐ ржкрзВрж░рзНржмрзЗ рждрзИрж░рж┐ ржХрж░рж╛ customerId ржнрзЗрж░рж┐ржпрж╝рзЗржмрж▓рзЗрж░ ржорж╛ржиржЯрж┐ ржзрж╛рж░ржг ржХрж░ржмрзЗред
products: ржПржЯрж┐ ржПржХржЯрж┐ empty ржЕрзНржпрж╛рж░рзЗ рж╣рж┐рж╕рж╛ржмрзЗ рж╢рзБрж░рзБ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗред ржПржЦрж╛ржирзЗ ржЕрж░рзНржбрж╛рж░рзЗ рж╕ржВржпрзБржХрзНржд product ржПрж░ рждрж╛рж▓рж┐ржХрж╛ ржерж╛ржХржмрзЗред
totalAmount: ржПржЯрж┐ 0 рж╣рж┐рж╕рж╛ржмрзЗ рж╢рзБрж░рзБ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗред ржПржЯрж┐ ржЕрж░рзНржбрж╛рж░рзЗрж░ ржорзЛржЯ ржорзВрж▓рзНржп ржзрж╛рж░ржг ржХрж░ржмрзЗред
for (const product of products) {
    const newProduct = await Product.create([product], { session });
    newOrder.products.push(newProduct[0]._id);
    newOrder.totalAmount += product.price * product.quantity;
  }
ржПржЗ ржХрзЛржбрзЗ ржПржХржЯрж┐ for рж▓рзБржк рж░ржпрж╝рзЗржЫрзЗ ржпрж╛ products ржЕрзНржпрж╛рж░рзЗрж░ ржкрзНрж░рждрж┐ржЯрж┐ product ржПрж░ ржЬржирзНржп ржЪрж▓ржмрзЗред рж▓рзБржкрзЗрж░ ржкрзНрж░рждрж┐ржЯрж┐ ржЗржЯрж╛рж░рзЗрж╢ржирзЗ, ржирж┐ржорзНржирж▓рж┐ржЦрж┐ржд ржХрж╛ржЬржЧрзБрж▓рж┐ ржХрж░рж╛ рж╣ржмрзЗ:
ржкрзНрж░рждрж┐ржЯрж┐ product ржЬржирзНржп ржПржХржЯрж┐ ржирждрзБржи product рждрзИрж░рж┐ ржХрж░рж╛ рж╣ржмрзЗ ржПржмржВ ржПржЯрж┐ Product ржоржбрзЗрж▓рзЗрж░ create ржорзЗржержб ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ рж╕ржВрж░ржХрзНрж╖ржг ржХрж░рж╛ рж╣ржмрзЗред ржПржЗ ржирждрзБржи product ржорж╛ржи рж╣рж┐рж╕рж╛ржмрзЗ ржПржХржЯрж┐ ржЕрзНржпрж╛рж░рзЗрждрзЗ рж╕ржВрж░ржХрзНрж╖ржг ржХрж░рж╛ рж╣ржмрзЗред
ржирждрзБржи product ржЖржЗржбрж┐ ржЯрж┐ newOrder.products ржЕрзНржпрж╛рж░рзЗрждрзЗ рж╕ржВржпрзБржХрзНржд ржХрж░рж╛ рж╣ржмрзЗред ржПржЯрж┐ ржХрж░рждрзЗ ржЖржорж░рж╛ newProduct[0]._id ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗржЫрж┐ред
newOrder.totalAmount ржП product ржорзВрж▓рзНржп ржУ ржкрж░рж┐ржорж╛ржгрзЗрж░ ржЧрзБржгржи ржХрж░рзЗ ржпрзЛржЧ ржХрж░рж╛ рж╣ржмрзЗред product ржорзВрж▓рзНржп ржУ ржкрж░рж┐ржорж╛ржг рж╣рж▓рзЛ product.price ржПржмржВ product.quantityред
const createdOrder = await Order.create([newOrder], { session });
newCreatedOrder=createdOrder[0]);
ржПржЗ рж▓рж╛ржЗржирзЗ, ржЖржорж░рж╛ Order ржоржбрзЗрж▓рзЗрж░ create ржорзЗржержб ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржирждрзБржи ржЕрж░рзНржбрж╛рж░рзЗрж░ рждржерзНржп ржбрж╛ржЯрж╛ржмрзЗрж╕рзЗ save ржХрж░ржЫрж┐ред ржкрзНрж░ржержо ржкрзНржпрж╛рж░рж╛ржорж┐ржЯрж╛рж░ рж╣рж┐рж╕рж╛ржмрзЗ ржЖржорж░рж╛ newOrder ржЕржмржЬрзЗржХрзНржЯржЯрж┐ ржПржХржЯрж┐ ржЕрзНржпрж╛рж░рзЗрж░ ржоржзрзНржпрзЗ ржкрж╛ржарж╛ржЪрзНржЫрж┐, ржжрзНржмрж┐рждрзАржпрж╝ ржкрзНржпрж╛рж░рж╛ржорж┐ржЯрж╛рж░ рж╣рж┐рж╕рж╛ржмрзЗ ржЖржорж░рж╛ session ржкрж╛рж╕ ржХрж░ржЫрж┐ред ржЖржорж░рж╛ createdOrder ржнрзЗрж░рж┐ржпрж╝рзЗржмрж▓рзЗ ржПржХржЯрж┐ ржЕрзНржпрж╛рж░рзЗрж░ рж░рзВржкрзЗ ржирждрзБржи ржЕрж░рзНржбрж╛рж░рзЗрж░ рждржерзНржп ржкрзЗржпрж╝рзЗржЫрж┐редржЖржорж░рж╛ createdOrder[0] ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ newCreatedOrder ржнрзЗрж░рж┐ржпрж╝рзЗржмрж▓рзЗ рж╢рзБржзрзБржорж╛рждрзНрж░ ржкрзНрж░ржержо ржЕрж░рзНржбрж╛рж░рзЗрж░ рждржерзНржпржЯрж┐ рж╕ржВрж░ржХрзНрж╖ржг ржХрж░рзЗржЫрж┐ред
ржПрж░ржкрж░рзЗ, await session.commitTransaction() рж▓рж╛ржЗржирзЗ ржЯрзНрж░рж╛ржиржЬрзЗржХрж╢ржи рж╕ржорзНржкржирзНржи ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ ржПржмржВ ржмрж░рзНрждржорж╛ржи рж╕рзЗрж╢ржи ржПрж░ ржЯрзНрж░рж╛ржиржЬрзЗржХрж╢ржи рж╢рзЗрж╖ ржХрж░рзЗ ржжрж┐ржЪрзНржЫрзЗред
рж╢рзЗрж╖рзЗ, await session.endSession() рж▓рж╛ржЗржирзЗ рж╕рзЗрж╢ржиржЯрж┐ рж╢рзЗрж╖ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗред
catch (error) { await session.abortTransaction(); await session.endSession(); throw error; }
catch ржПрж░ ржнрж┐рждрж░ ржЖрж╕рж╛ ржорж╛ржирзЗ ржПрж░рж░ **await session.abortTransaction()**рж▓рж╛ржЗржирзЗ, ржЯрзНрж░рж╛ржиржЬрзЗржХрж╢ржиржЯрж┐ ржХрзНржпрж╛ржирж╕рзЗрж▓ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ ред await session.endSession() рж▓рж╛ржЗржирзЗ, рж╕рзЗрж╢ржиржЯрж┐ close ржХрж░рж╛ рж╣ржЪрзНржЫрзЗред ржПрж░ржкрж░рзЗ, **throw error**рж╕рзНржЯрзЗржЯржорзЗржирзНржЯ ржжрзНржмрж╛рж░рж╛ ржПржХржЯрж┐ ржПрж░рж░ ржЕржмржЬрзЗржХрзНржЯ ржкрж╛ржарж╛ржирзЛ рж╣ржЪрзНржЫрзЗред